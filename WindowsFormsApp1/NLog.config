<?xml version="1.0" encoding="utf-8" ?>
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      autoReload="true" throwExceptions="false"
      internalLogLevel="Warn" internalLogFile="C:\Logs\AppLogs\nlog-internal.log">

  <targets async="true">
    <target name="jsonFile" xsi:type="AsyncWrapper" queueLimit="10000" overflowAction="Discard">
      <target xsi:type="File"
              fileName="C:\Logs\AppLogs\User-${windows-identity}\(${windows-session})-${shortdate}.log"
              archiveAboveSize="10485760" archiveNumbering="Rolling" maxArchiveFiles="5"
              keepFileOpen="false" concurrentWrites="true" openFileCacheTimeout="30">

        <layout xsi:type="JsonLayout" includeAllMdlc="true" maxRecursionLimit="3">
          <attribute name="timestamp" layout="${date:universalTime=true:format=o}" />
          <attribute name="level" layout="${level:upperCase=true}" />
          <attribute name="message" layout="${message}" />

          <!-- Context ID Hierarchy -->
          <attribute name="windowsSession" layout="${windows-session}" />
          <attribute name="sessionCorrelationId" layout="${mdlc:item=sessionCorrelationId}" />
          <attribute name="processId" layout="${processid}" />
          <attribute name="transactionId" layout="${event-properties:item=transactionId}" />

          <!-- General Context -->
          <attribute name="serverName" layout="${machinename}" />
          <attribute name="userName" layout="${windows-identity:domain=true}" />
          <attribute name="appName" layout="${mdlc:item=appName}" />
          <attribute name="appType" layout="${mdlc:item=appType}" />

          <!-- .NET Specific Context -->
          <attribute name="logger" layout="${logger}" />
          <attribute name="callsite" layout="${callsite:fileName=true:includeSourcePath=false:methodName=true}" />

          <!-- Exception Details -->
          <attribute name="exception" layout="${exception:format=toString,Data:maxInnerExceptionLevel=10}" />

          <!-- Structured Properties (from message templates or dictionaries) -->
          <attribute name="properties" encode="false">
            <layout xsi:type="JsonLayout" includeAllProperties="true" maxRecursionLimit="2" />
          </attribute>
        </layout>
      </target>
    </target>
  </targets>

  <rules>
    <logger name="*" minlevel="Debug" writeTo="jsonFile" />
  </rules>
</nlog>